name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - master
    tags:
      - v*

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  meta:
    name: Determine version + tag
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-actions[bot]' }}
    outputs:
      mode: ${{ steps.meta.outputs.mode }}
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Determine version + tag
        id: meta
        run: python scripts/gha/release/determine_meta.py

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: meta

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Apply version bump (auto mode)
        if: ${{ needs.meta.outputs.mode == 'auto' }}
        run: python scripts/gha/release/apply_version_bump.py --version "${{ needs.meta.outputs.version }}"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --locked

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [test, meta]
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Apply version bump (auto mode)
        if: ${{ needs.meta.outputs.mode == 'auto' }}
        run: python scripts/gha/release/apply_version_bump.py --version "${{ needs.meta.outputs.version }}"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Determine version
        id: version
        run: python scripts/gha/release/read_cargo_version.py

      - name: Build
        shell: bash
        run: cargo build --release --locked

      - name: Package assets
        run: python scripts/gha/release/package_assets.py --version "${{ steps.version.outputs.version }}"

      - name: Upload assets
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: dist/*
          if-no-files-found: error

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, meta]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Apply version bump (auto mode)
        if: ${{ needs.meta.outputs.mode == 'auto' }}
        run: python scripts/gha/release/apply_version_bump.py --version "${{ needs.meta.outputs.version }}"

      - name: Determine version
        id: version
        run: python scripts/gha/release/read_cargo_version.py

      - name: Check release existence
        id: check
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: python scripts/gha/release/check_release_exists.py --version "${{ steps.version.outputs.version }}"

      - name: Configure git (auto mode)
        if: ${{ steps.check.outputs.exists == 'false' && needs.meta.outputs.mode == 'auto' }}
        run: python scripts/gha/common/configure_git_bot.py

      - name: Download assets (temp, for Scoop hash)
        if: ${{ steps.check.outputs.exists == 'false' && needs.meta.outputs.mode == 'auto' }}
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: .tmp_release_dist
          merge-multiple: true

      - name: Update `bucket/ztnet.json` (auto mode)
        if: ${{ steps.check.outputs.exists == 'false' && needs.meta.outputs.mode == 'auto' }}
        run: python scripts/gha/release/update_scoop_manifest.py --version "${{ steps.version.outputs.version }}" --sha-file ".tmp_release_dist/ztnet-${{ steps.version.outputs.version }}-x86_64-pc-windows-msvc.zip.sha256" --cleanup-dir ".tmp_release_dist"

      - name: Commit + tag (auto mode)
        if: ${{ steps.check.outputs.exists == 'false' && needs.meta.outputs.mode == 'auto' }}
        run: python scripts/gha/release/commit_and_tag.py --version "${{ steps.version.outputs.version }}"

      - name: Publish to crates.io
        if: ${{ steps.check.outputs.exists == 'false' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: python scripts/gha/release/publish_crates.py

      - name: Download assets
        if: ${{ steps.check.outputs.exists == 'false' }}
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist
          merge-multiple: true

      - name: Stage npm artifacts
        if: ${{ steps.check.outputs.exists == 'false' }}
        run: python scripts/gha/release/stage_npm_artifacts.py --version "${{ steps.version.outputs.version }}"

      - name: Create release
        if: ${{ steps.check.outputs.exists == 'false' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: python scripts/gha/release/create_release.py --version "${{ steps.version.outputs.version }}"

      - name: Setup Node (Trusted Publishing)
        if: ${{ steps.check.outputs.exists == 'false' }}
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Ensure npm CLI version
        if: ${{ steps.check.outputs.exists == 'false' }}
        run: npm i -g npm@11.5.1

      - name: Verify npm package version
        if: ${{ steps.check.outputs.exists == 'false' }}
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: node npm/scripts/verify-version.js

      - name: Publish to npm
        if: ${{ steps.check.outputs.exists == 'false' }}
        working-directory: npm
        env:
          NODE_AUTH_TOKEN: ""
        run: npm publish --provenance

  winget:
    name: Open WinGet PR
    runs-on: windows-latest
    needs: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check token
        id: token
        env:
          WINGET_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: python scripts/gha/common/check_env_output.py --env-var WINGET_TOKEN --missing-message "WINGET_TOKEN not set; skipping"

      - name: Check winget-pkgs has package
        id: pkg
        if: ${{ steps.token.outputs.present == 'true' }}
        run: python scripts/gha/release/check_winget_pkgs_package.py

      - name: Publish to WinGet
        if: ${{ steps.token.outputs.present == 'true' && steps.pkg.outputs.exists == 'true' }}
        uses: vedantmgoyal9/winget-releaser@main
        with:
          identifier: JKamsker.ZTNetCLI
          installers-regex: 'x86_64-pc-windows-msvc\\.zip$'
          token: ${{ secrets.WINGET_TOKEN }}

  chocolatey:
    name: Publish to Chocolatey
    runs-on: windows-latest
    needs: [release, meta]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check token
        id: token
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: python scripts/gha/common/check_env_output.py --env-var CHOCO_API_KEY --missing-message "CHOCO_API_KEY not set; skipping"

      - name: Pack + push
        if: ${{ steps.token.outputs.present == 'true' }}
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
          ZTNET_VERSION: ${{ needs.meta.outputs.version }}
        run: .\scripts\gha\chocolatey\publish.ps1
