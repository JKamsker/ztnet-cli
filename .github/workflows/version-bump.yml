name: Version bump

on:
  push:
    branches:
      - master

permissions:
  contents: write

concurrency:
  group: version-bump-${{ github.ref }}
  cancel-in-progress: false

jobs:
  bump:
    name: Bump patch version
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-actions[bot]' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Configure git
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump version (patch)
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          NEW_VERSION="$(
          python - <<'PY'
          import re
          import subprocess
          import tomllib
          from pathlib import Path

          crate_name = "ztnet"
          cargo_toml = Path("Cargo.toml")
          cargo_lock = Path("Cargo.lock")

          data = tomllib.loads(cargo_toml.read_text("utf-8"))
          current = data["package"]["version"]

          m = re.fullmatch(r"(\d+)\.(\d+)\.(\d+)", current)
          if not m:
            raise SystemExit(f"Unsupported version format: {current!r}")

          major, minor, patch = map(int, m.groups())

          while True:
            patch += 1
            candidate = f"{major}.{minor}.{patch}"
            tag = f"v{candidate}"
            result = subprocess.run(
              ["git", "rev-parse", "-q", "--verify", f"refs/tags/{tag}"],
              stdout=subprocess.DEVNULL,
              stderr=subprocess.DEVNULL,
            )
            if result.returncode != 0:
              new_version = candidate
              break

          # Update Cargo.toml: [package].version
          lines = cargo_toml.read_text("utf-8").splitlines()
          in_package = False
          updated = False
          for i, line in enumerate(lines):
            if line.strip() == "[package]":
              in_package = True
              continue
            if in_package and line.startswith("[") and line.strip() != "[package]":
              in_package = False
            if in_package and line.strip().startswith("version"):
              lines[i] = f'version = "{new_version}"'
              updated = True
              break

          if not updated:
            raise SystemExit("Could not update [package].version in Cargo.toml")

          cargo_toml.write_text("\\n".join(lines) + "\\n", encoding="utf-8")

          # Update Cargo.lock: root package version (minimal edit)
          if cargo_lock.is_file():
            lock_lines = cargo_lock.read_text("utf-8").splitlines()
            for i, line in enumerate(lock_lines):
              if line.strip() == f'name = "{crate_name}"':
                for j in range(i + 1, min(i + 20, len(lock_lines))):
                  if lock_lines[j].strip().startswith("version ="):
                    lock_lines[j] = f'version = "{new_version}"'
                    cargo_lock.write_text("\\n".join(lock_lines) + "\\n", encoding="utf-8")
                    break
                else:
                  raise SystemExit(f"Could not find version for {crate_name} in Cargo.lock")
                break

          print(new_version)
          PY
          )"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit bump
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.bump.outputs.new_version }}"

          if [[ -z "$VERSION" ]]; then
            echo "No version produced"
            exit 1
          fi

          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add Cargo.toml Cargo.lock
          git commit -m "chore(release): v${VERSION}"

          git tag -a "v${VERSION}" -m "v${VERSION}"

      - name: Push
        shell: bash
        run: |
          set -euo pipefail
          git push origin master
          git push origin --tags
